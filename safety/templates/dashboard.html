{% extends "base.html" %}

{% block title %}뮤지엄 AI 보안 시스템{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- [좌측] AI 제어 패널 (사이드바) -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-cogs"></i> AI 제어 패널
                </div>
                <div class="card-body p-0">
                    <!-- 탭 메뉴 헤더 -->
                    <ul class="nav nav-tabs nav-fill" id="aiTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="source-tab" data-bs-toggle="tab" data-bs-target="#source" type="button" role="tab">
                                <i class="fas fa-video"></i> 소스
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="zone-tab" data-bs-toggle="tab" data-bs-target="#zone" type="button" role="tab">
                                <i class="fas fa-draw-polygon"></i> 구역
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="detect-tab" data-bs-toggle="tab" data-bs-target="#detect" type="button" role="tab">
                                <i class="fas fa-sliders-h"></i> 감지
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="monitor-tab" data-bs-toggle="tab" data-bs-target="#monitor" type="button" role="tab">
                                <i class="fas fa-desktop"></i> 모니터
                            </button>
                        </li>
                    </ul>

                    <!-- 탭 메뉴 내용 -->
                    <div class="tab-content p-3" id="aiTabsContent">

                        <!-- 1. 영상 소스 관리 -->
                        <div class="tab-pane fade show active" id="source" role="tabpanel">
                            <h6 class="border-bottom pb-2 mb-3">영상 입력 소스</h6>
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-outline-primary text-start" onclick="changeSource('0', 'webcam')">
                                    <i class="fas fa-camera me-2"></i> 웹캠 (0번)
                                </button>
                            </div>

                            <!-- 업로드된 비디오 목록 -->
                            <label class="form-label small text-muted">업로드된 영상 선택</label>
                            <select class="form-select mb-3" id="videoSelect">
                                <option value="" selected disabled>영상 선택...</option>
                                <!-- 자바스크립트로 목록이 채워짐 -->
                            </select>

                            <hr>
                            <div class="input-group mb-3">
                                <input type="file" class="form-control" id="videoUpload" accept="video/*">
                                <button class="btn btn-outline-secondary" type="button" onclick="uploadVideo()">업로드</button>
                            </div>

                            <!-- 모델 선택 셀렉트 박스 추가 -->
                            <h6 class="border-bottom pb-2 mb-3 mt-4">AI 모델 선택</h6>
                            <select class="form-select" id="modelSelect">
                                <option value="yolov8n-pose.pt" selected>YOLOv8 Nano (빠름)</option>
                                <option value="yolov8s-pose.pt">YOLOv8 Small (보통)</option>
                                <option value="yolov8m-pose.pt">YOLOv8 Medium (균형)</option>
                                <option value="yolov8l-pose.pt">YOLOv8 Large (정확)</option>
                                <option value="yolov8x-pose.pt">YOLOv8 X-Large (최고성능)</option>
                            </select>
                        </div>

                        <!-- 2. 구역 설정 -->
                        <div class="tab-pane fade" id="zone" role="tabpanel">
                            <h6 class="border-bottom pb-2 mb-3">감지 구역 설정</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="drawModeSwitch">
                                <label class="form-check-label" for="drawModeSwitch">그리기 모드 활성화</label>
                            </div>
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle"></i> 영상 위를 클릭하여 4개의 점을 찍으세요.
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Yellow Zone 확장 비율: <span id="expandVal">50</span>%</label>
                                <input type="range" class="form-range" id="expandSlider" min="0" max="100" value="50">
                            </div>
                            <button class="btn btn-primary w-100 mb-3" id="saveZoneBtn">설정 저장</button>

                            <!-- 구역 목록 표시 영역 -->
                            <h6 class="border-bottom pb-2 mb-2">구역 목록</h6>
                            <div id="zoneList" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;">
                                <div class="text-center text-muted py-3">설정된 구역이 없습니다.</div>
                            </div>
                        </div>

                        <!-- 3. 감지 설정 -->
                        <div class="tab-pane fade" id="detect" role="tabpanel">
                            <h6 class="border-bottom pb-2 mb-3">AI 감지 민감도</h6>

                            <div class="mb-3">
                                <label class="form-label small">사람 탐지 신뢰도: <span id="confVal">50</span>%</label>
                                <input type="range" class="form-range" id="confSlider" min="0.01" max="1.0" step="0.01" value="0.5">
                            </div>

                            <h6 class="border-bottom pb-2 mb-3 mt-4">행동 감지 설정</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="reachCheck" checked>
                                <label class="form-check-label" for="reachCheck">팔 뻗음 감지 활성화</label>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">손 높이 상한선: <span id="heightVal">20</span>%</label>
                                <input type="range" class="form-range" id="heightSlider" min="0" max="100" value="20">
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">팔꿈치 각도: <span id="angleVal">140</span>°</label>
                                <input type="range" class="form-range" id="angleSlider" min="90" max="180" value="140">
                            </div>

                            <!-- 쓰러짐 감지 체크박스 -->
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" id="fallCheck">
                                <label class="form-check-label" for="fallCheck">쓰러짐 감지 활성화</label>
                            </div>

                            <!-- 감지 설정 저장 버튼 -->
                            <button class="btn btn-primary w-100 mt-3" id="saveDetectBtn">설정 저장</button>
                        </div>

                        <!-- 4. 실시간 모니터 -->
                        <div class="tab-pane fade" id="monitor" role="tabpanel">
                            <!-- 화면 표시 설정 -->
                            <h6 class="border-bottom pb-2 mb-3">화면 표시 설정</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="drawObjectsCheck" checked>
                                <label class="form-check-label" for="drawObjectsCheck">객체 그리기 (사람/스켈레톤)</label>
                            </div>
                            <!-- [추가] 구역 보이기 스위치 -->
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="drawZonesCheck" checked>
                                <label class="form-check-label" for="drawZonesCheck">구역 보이기</label>
                            </div>
                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" id="showOnlyAlertCheck">
                                <label class="form-check-label" for="showOnlyAlertCheck">감지 시에만 표시</label>
                            </div>

                            <h6 class="border-bottom pb-2 mb-3">실시간 이벤트 로그</h6>
                            <div class="list-group list-group-flush small" style="height: 300px; overflow-y: auto;">
                                <div class="list-group-item list-group-item-danger">
                                    <span class="fw-bold">[21:45:12]</span> DANGER! (Red Zone)
                                </div>
                                <div class="list-group-item list-group-item-warning">
                                    <span class="fw-bold">[21:44:05]</span> WARNING (Yellow Zone)
                                </div>
                                <div class="list-group-item">
                                    <span class="fw-bold">[21:40:00]</span> 시스템 시작됨
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [우측] 메인 영상 영역 -->
        <div class="col-lg-9">
            <div class="card shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-video text-danger me-2"></i> CAM-01 (Main Hall)</span>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body p-0 text-center bg-black position-relative">
                    <!-- 영상 스트리밍 -->
                    <img id="videoStream" src="{{ url_for('ai_safety.video_feed') }}" class="img-fluid" style="width: 100%; height: auto; max-height: 80vh;">

                    <!-- 캔버스 오버레이 (구역 그리기용) -->
                    <canvas id="zoneCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 분리된 JS 파일 로드 (캐시 방지) -->
<script src="{{ url_for('ai_safety.static', filename='js/dashboard.js') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}
